{% extends '@PrestaShop/Admin/layout.html.twig' %}

{% block content %}
<div class="row">
  <div class="col-12">
    {% if error %}
    <div class="alert alert-danger" role="alert">
      <h4 class="alert-heading">
        <i class="material-icons">error</i> Error de conexi√≥n
      </h4>
      <p>{{ error }}</p>
      {% if not hasConfig %}
      <hr>
      <p class="mb-0">
        <a href="{{ '/admin-dev/index.php?controller=AdminModules&configure=sync_ps_to_ps_importer'|raw }}" class="btn btn-primary">
          <i class="material-icons">settings</i> Configurar m√≥dulo
        </a>
      </p>
      {% endif %}
    </div>
    {% endif %}

    {% if connectionStatus and connectionStatus.success %}
    <div class="alert alert-success" role="alert">
      <i class="material-icons">check_circle</i> <strong>Conectado exitosamente</strong> a {{ apiUrl }}
    </div>
    {% endif %}
  </div>
</div>

{% if hasConfig and not error %}
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-header-title">
          <i class="material-icons">filter_list</i>
          Filtros
        </h3>
      </div>
      <div class="card-body">
        <form method="get" class="form-inline">
          <input type="hidden" name="token" value="{{ adminToken }}">
          
          <div class="form-group mr-3">
            <label for="search" class="mr-2">Buscar:</label>
            <input type="text" class="form-control" id="search" name="search" placeholder="Nombre del producto" value="{{ currentSearch }}">
          </div>
          
          <div class="form-group mr-3">
            <label for="category" class="mr-2">Categor√≠a:</label>
            <select class="form-control" id="category" name="category">
              <option value="">Todas las categor√≠as</option>
              {% for category in categories %}
                {% set categoryName = category.name is iterable ? (category.name[1] ?? category.name|first) : category.name %}
                <option value="{{ category.id }}" {% if currentCategory == category.id %}selected{% endif %}>{{ categoryName }}</option>
              {% endfor %}
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="material-icons">search</i> Buscar
          </button>
          
          {% if currentSearch or currentCategory %}
          <a href="?token={{ adminToken }}" class="btn btn-secondary ml-2">
            <i class="material-icons">clear</i> Limpiar filtros
          </a>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-header-title">
          <i class="material-icons">shopping_cart</i>
          Productos disponibles para importar
        </h3>
        <div class="card-header-actions">
          <a href="{{ path('admin_sync_ps_to_ps_importer_logs') }}" class="btn btn-outline-info mr-2">
            <i class="material-icons">description</i> Ver Logs
          </a>
          <button id="importSelected" class="btn btn-success">
            <i class="material-icons">cloud_download</i> Importar seleccionados
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if products is empty %}
        <p class="text-center text-muted">
          <i class="material-icons" style="font-size: 48px;">inbox</i>
          <br>
          No se encontraron productos
        </p>
        {% else %}
        
        {# Informaci√≥n de paginaci√≥n superior #}
        {% if pagination %}
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="text-muted">
            <i class="material-icons" style="vertical-align: middle; font-size: 18px;">info</i>
            Mostrando <strong>{{ pagination.showing_from }}</strong> - <strong>{{ pagination.showing_to }}</strong> de <strong>{{ pagination.total_items }}</strong> productos
          </div>
          <div>
            <label class="mb-0 mr-2">Productos por p√°gina:</label>
            <select id="limitSelector" class="form-control form-control-sm d-inline-block" style="width: auto;">
              <option value="10" {% if pagination.limit == 10 %}selected{% endif %}>10</option>
              <option value="20" {% if pagination.limit == 20 %}selected{% endif %}>20</option>
              <option value="50" {% if pagination.limit == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if pagination.limit == 100 %}selected{% endif %}>100</option>
            </select>
          </div>
        </div>
        {% endif %}
        
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th width="40">
                  <input type="checkbox" id="selectAll">
                </th>
                <th width="60">ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Referencia</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr>
                <td>
                  <input type="checkbox" class="product-checkbox" value="{{ product.id }}">
                </td>
                <td>{{ product.id }}</td>
                <td>
                  {% if product.id_default_image %}
                    {% set productName = product.name is iterable ? (product.name[1] ?? product.name|first) : product.name %}
                    {% set linkRewrite = product.link_rewrite is iterable ? (product.link_rewrite[1] ?? product.link_rewrite|first) : product.link_rewrite %}
                    <img src="{{ apiUrl }}/{{ product.id }}-small_default/{{ linkRewrite }}.jpg" 
                         alt="{{ productName }}" 
                         class="img-thumbnail" 
                         style="max-width: 50px;"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'50\' height=\'50\'%3E%3Crect fill=\'%23eee\' width=\'50\' height=\'50\'/%3E%3C/svg%3E'">
                  {% else %}
                    <div class="bg-light text-center" style="width: 50px; height: 50px; line-height: 50px;">
                      <i class="material-icons">image</i>
                    </div>
                  {% endif %}
                </td>
                <td>
                  {% set productName = product.name is iterable ? (product.name[1] ?? product.name|first) : product.name %}
                  <strong>{{ productName ?? 'Sin nombre' }}</strong>
                </td>
                <td>{{ product.reference ?? '' }}</td>
                <td>{{ product.price ?? '0' }} ‚Ç¨</td>
                <td>{{ product.quantity ?? 0 }}</td>
                <td>
                  {% if product.active == '1' %}
                    <span class="badge badge-success">Activo</span>
                  {% else %}
                    <span class="badge badge-secondary">Inactivo</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        {# Controles de paginaci√≥n inferior #}
        {% if pagination and pagination.total_pages > 1 %}
        <div class="d-flex justify-content-center mt-4">
          <nav aria-label="Paginaci√≥n de productos">
            <ul class="pagination">
              {# Bot√≥n Anterior #}
              <li class="page-item {% if not pagination.has_previous %}disabled{% endif %}">
                {% if pagination.has_previous %}
                  <a class="page-link" href="?offset={{ pagination.previous_offset }}&limit={{ pagination.limit }}{% if currentCategory %}&category={{ currentCategory }}{% endif %}{% if currentSearch %}&search={{ currentSearch }}{% endif %}&token={{ adminToken }}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Anterior</span>
                  </a>
                {% else %}
                  <span class="page-link">
                    <span aria-hidden="true">&laquo;</span>
                  </span>
                {% endif %}
              </li>

              {# N√∫meros de p√°gina #}
              {% set start_page = max(1, pagination.current_page - 2) %}
              {% set end_page = min(pagination.total_pages, pagination.current_page + 2) %}
              
              {# Primera p√°gina si no est√° visible #}
              {% if start_page > 1 %}
                <li class="page-item">
                  <a class="page-link" href="?offset=0&limit={{ pagination.limit }}{% if currentCategory %}&category={{ currentCategory }}{% endif %}{% if currentSearch %}&search={{ currentSearch }}{% endif %}&token={{ adminToken }}">1</a>
                </li>
                {% if start_page > 2 %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
              {% endif %}

              {# P√°ginas visibles #}
              {% for page in start_page..end_page %}
                {% set page_offset = (page - 1) * pagination.limit %}
                <li class="page-item {% if page == pagination.current_page %}active{% endif %}">
                  <a class="page-link" href="?offset={{ page_offset }}&limit={{ pagination.limit }}{% if currentCategory %}&category={{ currentCategory }}{% endif %}{% if currentSearch %}&search={{ currentSearch }}{% endif %}&token={{ adminToken }}">{{ page }}</a>
                </li>
              {% endfor %}

              {# √öltima p√°gina si no est√° visible #}
              {% if end_page < pagination.total_pages %}
                {% if end_page < pagination.total_pages - 1 %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                <li class="page-item">
                  {% set last_offset = (pagination.total_pages - 1) * pagination.limit %}
                  <a class="page-link" href="?offset={{ last_offset }}&limit={{ pagination.limit }}{% if currentCategory %}&category={{ currentCategory }}{% endif %}{% if currentSearch %}&search={{ currentSearch }}{% endif %}&token={{ adminToken }}">{{ pagination.total_pages }}</a>
                </li>
              {% endif %}

              {# Bot√≥n Siguiente #}
              <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                {% if pagination.has_next %}
                  <a class="page-link" href="?offset={{ pagination.next_offset }}&limit={{ pagination.limit }}{% if currentCategory %}&category={{ currentCategory }}{% endif %}{% if currentSearch %}&search={{ currentSearch }}{% endif %}&token={{ adminToken }}" aria-label="Siguiente">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Siguiente</span>
                  </a>
                {% else %}
                  <span class="page-link">
                    <span aria-hidden="true">&raquo;</span>
                  </span>
                {% endif %}
              </li>
            </ul>
          </nav>
        </div>
        {% endif %}
        
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

{# Modal de progreso #}
<div class="modal fade" id="importModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importando productos</h5>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" 
               role="progressbar" 
               style="width: 100%"></div>
        </div>
        <p class="mt-3 text-center" id="importMessage">Por favor espera...</p>
      </div>
    </div>
  </div>
</div>

<style>
.card-header-actions {
  margin-left: auto;
  display: flex;
  gap: 0.5rem;
}
.product-checkbox {
  cursor: pointer;
}
tbody tr:hover {
  background-color: #f8f9fa;
}
.mr-2 {
  margin-right: 0.5rem;
}

/* Estilos de paginaci√≥n */
.pagination {
  margin-bottom: 0;
}
.pagination .page-link {
  color: #6c757d;
  border-color: #dee2e6;
}
.pagination .page-item.active .page-link {
  background-color: #25b9d7;
  border-color: #25b9d7;
  color: white;
}
.pagination .page-link:hover {
  background-color: #f8f9fa;
  border-color: #dee2e6;
  color: #495057;
}
.pagination .page-item.disabled .page-link {
  color: #6c757d;
  pointer-events: none;
  cursor: not-allowed;
  background-color: #fff;
  border-color: #dee2e6;
}

/* Selector de l√≠mite */
#limitSelector {
  cursor: pointer;
  transition: border-color 0.15s ease-in-out;
}
#limitSelector:hover {
  border-color: #80bdff;
}

/* Informaci√≥n de paginaci√≥n */
.text-muted strong {
  color: #495057;
}
</style>

<script>
(function() {
  'use strict';
  
  console.log('üîÑ Iniciando script de sincronizaci√≥n...');
  
  // Esperar a que el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSync);
  } else {
    initSync();
  }
  
  function initSync() {
    console.log('‚úÖ DOM listo, inicializando...');
    
    const selectAll = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const importBtn = document.getElementById('importSelected');
    const importModalEl = document.getElementById('importModal');
    const limitSelector = document.getElementById('limitSelector');
    
    console.log('Elementos encontrados:', {
      selectAll: !!selectAll,
      checkboxes: productCheckboxes.length,
      importBtn: !!importBtn,
      modal: !!importModalEl,
      limitSelector: !!limitSelector
    });
    
    // Cambiar l√≠mite de productos por p√°gina
    if (limitSelector) {
      limitSelector.addEventListener('change', function() {
        const newLimit = this.value;
        const url = new URL(window.location.href);
        url.searchParams.set('limit', newLimit);
        url.searchParams.set('offset', '0'); // Volver a la primera p√°gina
        
        // Asegurar que el token est√© presente
        const currentToken = url.searchParams.get('token');
        if (!currentToken) {
          url.searchParams.set('token', '{{ adminToken }}');
        }
        
        console.log('Cambiando l√≠mite a:', newLimit);
        window.location.href = url.toString();
      });
    }
    
    // Crear instancia del modal (con fallback si bootstrap no est√° disponible)
    let importModal = null;
    if (importModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      importModal = new bootstrap.Modal(importModalEl);
    }
    
    // Seleccionar/deseleccionar todos
    if (selectAll) {
      selectAll.addEventListener('change', function() {
        console.log('Toggle all:', this.checked);
        productCheckboxes.forEach(cb => {
          cb.checked = this.checked;
        });
        updateImportButton();
      });
    }
    
    // Actualizar bot√≥n al seleccionar productos
    productCheckboxes.forEach(cb => {
      cb.addEventListener('change', function() {
        console.log('Checkbox changed:', this.value, this.checked);
        updateImportButton();
      });
    });
    
    // Llamar una vez al inicio para actualizar el estado
    updateImportButton();
    
    function updateImportButton() {
      const selected = Array.from(productCheckboxes).filter(cb => cb.checked);
      console.log('Actualizando bot√≥n. Seleccionados:', selected.length);
      
      if (importBtn) {
        importBtn.disabled = selected.length === 0;
        const icon = '<i class="material-icons">cloud_download</i>';
        importBtn.innerHTML = selected.length > 0 
          ? icon + ` Importar ${selected.length} producto(s)` 
          : icon + ' Importar seleccionados';
        console.log('Bot√≥n habilitado:', !importBtn.disabled);
      }
    }
    
    // Importar productos seleccionados
    if (importBtn) {
      importBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const selected = Array.from(productCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        
        console.log('Importar clicked. Productos:', selected);
        
        if (selected.length === 0) {
          alert('Por favor, selecciona al menos un producto');
          return;
        }
        
        // Confirmaci√≥n
        if (!confirm(`¬øImportar ${selected.length} producto(s)?`)) {
          return;
        }
        
        // Deshabilitar bot√≥n durante la importaci√≥n
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="material-icons">hourglass_empty</i> Importando...';
        
        // Mostrar modal de progreso si est√° disponible
        if (importModal) {
          importModal.show();
        }
        
        // Construir URL correcta usando la ruta de Symfony
        const importUrl = '{{ path('admin_sync_ps_to_ps_importer_import') }}';
        console.log('URL de importaci√≥n:', importUrl);
        
        // Enviar petici√≥n AJAX
        fetch(importUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            product_ids: selected
          })
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          
          if (importModal) {
            importModal.hide();
          }
          
          if (data.success) {
            alert('‚úì ' + data.message);
            // Recargar la p√°gina
            window.location.reload();
          } else {
            // Mostrar mensaje de error principal
            let errorMsg = '‚úó ' + data.message;
            
            // A√±adir detalles de errores si existen
            if (data.details && data.details.messages && data.details.messages.length > 0) {
              errorMsg += '\n\nDetalles:\n' + data.details.messages.join('\n');
              console.error('Errores detallados:', data.details.messages);
            }
            
            // Mostrar logs completos en consola para debugging
            if (data.details && data.details.logs) {
              console.group('üìã Logs detallados de importaci√≥n');
              Object.keys(data.details.logs).forEach(key => {
                console.group(key);
                data.details.logs[key].forEach(log => console.log(log));
                console.groupEnd();
              });
              console.groupEnd();
              
              errorMsg += '\n\n‚ö†Ô∏è Ver logs detallados en la consola del navegador (F12)';
            }
            
            // Mostrar trace si existe
            if (data.trace) {
              console.error('Stack trace:', data.trace);
            }
            
            alert(errorMsg);
            
            // Re-habilitar bot√≥n
            importBtn.disabled = false;
            updateImportButton();
          }
        })
        .catch(error => {
          console.error('Error de fetch:', error);
          
          if (importModal) {
            importModal.hide();
          }
          
          alert('‚úó Error de conexi√≥n: ' + error.message);
          
          // Re-habilitar bot√≥n
          importBtn.disabled = false;
          updateImportButton();
        });
      });
    }
  }
})();
</script>
{% endblock %}
